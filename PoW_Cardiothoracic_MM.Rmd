---
title: "Untitled"
author: "Rory Denham"
date: "March 22, 2019
---


##Purpose

This is an R Markdown file intended for the automation of monthly cardiac surgery data review reports as a part of morbidity and mortality (M&M) review at Prince of Wales hospital NSW. All input data is sourced directly from the local Cardiothoracic Surgery database at Prince of Wales.

##Background of M&M Review

NSW health policy requires monthly M&M reports be created to review serious complications such as deaths or surgical mismanagement. Ordinarily M&M reports are created as a case-by-case patient review wherein the Advanced Surgical Trainee (AT) outlines each patient's medical history, pre-operative course, surgical proceedure and post-operative course in a narrative structure using Microsoft PowerPoint software and a combination of physical and electronic patient records. The M&M reports are then presented at regularly scheduled department meetings on either a monthly, or bi-monthly basis depending on the availability of key parties such as the surgical consultants. 

However, due to the complex nature of cardiac surgery and the need for a data oriented approach to clincal review processes, a data review component was added to the existing M&M case review reports within the Cardiothoracic Surgery department at Prince of Wales. This presents an opportunity for the relevant stateholders to discuss and address current issues such as infections, pre-op wait times, and post-op complications in the context of historical data.

This R markdown file is intended to produce the relevant summary statistics in a timely, reliable, and transparent manner.

##Technical Details

At the time of creating this project, the decision was made to output the report in the form of a Microsoft PowerPoint file for a few key reasons. The most significant reason is that hospital staff are highly familiar the Microsoft Office Suite and highly favour Microsoft PowerPoint for presentation purposes. However, the Case-by-case review portion of the M&M (created by the Advanced Surgical Trainee) also needs to be merged to the end of the Data Review section (created using this R Markdown file) and this is easiest using PowerPoint. 

Regarless, the decision to use PowerPoint presented some challanges. At the time of creation R Markdown output in the form of powerpoint files was still in it's testing phase and did not offer a high degree of flexibility when producing tables and formatting sldes. Fortunately, an alternative package 'OfficeR' presented a good alternative allowing for some more complex manipulation of the slide structure and the use of a Template slide structure using a reference powerpoint file.

The reference powerpoint file for this project is key for Producing the background graphics within each slide and there are specific reference themes available depending on the requirement for the slide presentation eg. for rendering a single large graph or multiple tables etc. 

The reference themes function by using a series of placeholders for a given theme eg. 1 large placeholder with a defined length and width taking up the majority of the slide, and 1 smaller text placeholder for a title. Using R we can assign our tables formatted using 'dplyr' and graphs formatted using 'ggplot2' to a placeholder, finally compiling everything as a single neat powerpoint output file.

The creation and formatting of the tables and graphs uses 4 input csv files is done first for each of the final documents 24 sildes.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#Load Libraries ------------------------
library(officer)
library(magrittr)
library(tidyverse)
library(flextable)
library(janitor)
library(lubridate)
library(scales)
library(stringr)
library(tibble)
library(knitr)
library(kableExtra)
```

```{r Function_Setup}

#simplifying Kable function calls
my_kable <- function(dataframe) {
kable(dataframe) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}

#function for percentages
percentage_func <- function(VectorToSum, percentagedenominator){
  paste(sum(VectorToSum, na.rm = TRUE), " (", round(sum(VectorToSum, na.rm = TRUE)/percentagedenominator*100, 2), "%)", sep = "")
}

```


```{r DataCleaning, echo = FALSE, message = FALSE, results = 'hide'}
#Load Data -----------------------------

#####
#change this file accordingly >>>>D:/M&M_Query_Data/ "insert pathfile here"

#PathFile <- "D:M&M_Query_Data_Laura/Oct_Nov/"
Pathfile <- "C:\\Users\\Break\\Desktop\\MM_Jan_2019_Data\\"

#####

#change to use readr package - require downloading the package first
MM.Inf <-       read_csv(file = paste(Pathfile, "qry_MMPres_Inf.csv", sep = ""))
MM.Pres_Main <- read_csv(file = paste(Pathfile, "qry_MMPres_Main.csv", sep = ""))
MM.ReAdm <-     read_csv(file = paste(Pathfile, "qry_MMPres_ReAdm.csv", sep = ""))
MM.RTT <-       read_csv(file = paste(Pathfile, "qry_MMPres_RTT.csv", sep = ""))

#Data cleaning and wrangling ------------------

####Fix Variable formats####

str(MM.Pres_Main)
MM.Pres_Main$AdmDate <- as.Date(MM.Pres_Main$AdmDate, "%d/%m/%Y")
MM.Pres_Main$ConsultDate <- as.Date(MM.Pres_Main$ConsultDate, "%d/%m/%Y")
MM.Pres_Main$OpDate <- as.Date(MM.Pres_Main$OpDate, "%d/%m/%Y")
MM.Pres_Main$DischargeDate <- as.Date(MM.Pres_Main$DischargeDate, "%d/%m/%Y")
MM.Pres_Main$PO_ICUAdmDt <- as.Date(MM.Pres_Main$PO_ICUAdmDt, "%d/%m/%Y")
MM.Pres_Main$PO_ICUOutDt <- as.Date(MM.Pres_Main$PO_ICUOutDt, "%d/%m/%Y")
MM.Pres_Main$PO_RFWDt <- as.Date(MM.Pres_Main$PO_RFWDt, "%d/%m/%Y")
MM.Pres_Main$PO_ExtbDt <- as.Date(MM.Pres_Main$PO_ExtbDt, "%d/%m/%Y")
MM.Pres_Main$PreOp_Comments <- as.character(MM.Pres_Main$PreOp_Comments)
MM.Pres_Main$PO_Comments <- as.character(MM.Pres_Main$PO_Comments)


MM.Pres_Main$OpCategory <- factor(MM.Pres_Main$OpCategory, levels = (c("CABG",
                                                                       "CABG/Other",
                                                                       "Valve",
                                                                       "Valve/Other",
                                                                       "CABG/Valve",
                                                                       "CABG/Valve/Other",
                                                                       "Other")))


MM.Inf$OpDate <- as.Date(MM.Inf$OpDate, "%d/%m/%Y")
MM.ReAdm$OpDate <- format(as.Date(MM.ReAdm$OpDate, "%d/%m/%Y"), "%d/%m/%Y")
MM.RTT$OpDate <- as.Date(MM.RTT$OpDate, "%d/%m/%Y")

#create date number variable
MM.Pres_Main$Num_Months <- month(MM.Pres_Main$OpDate) - month(min(MM.Pres_Main$OpDate)) + 1
MM.Inf$Num_Months <- month(MM.Inf$OpDate) - month(min(MM.Inf$OpDate)) + 1

#add month variable
MM.Pres_Main %<>% mutate(Month = month(OpDate, label = TRUE, abbr = FALSE))
MM.Inf %<>% mutate(Month = month(OpDate, label = TRUE, abbr = FALSE)) 

MM.Pres_Main %<>% mutate(`PO_Vent>24hr` = if_else(PO_ICUAdmDt-PO_ExtbDt>=1, 1, 0))

#add the total caseload (per month) to inf table
monthtotals <- MM.Pres_Main %>%
  group_by(Month) %>% 
  summarise(Total = n()) %>% 
  arrange(Month) %>% 
  select(Month, Total)

if(nrow(MM.Inf) != 0) {
  MM.Inf %<>% group_by(`Patient Details`) %>% 
    mutate(TotalCasesMonthly = if_else(Num_Months == 1, monthtotals[[1, 2]], monthtotals[[2, 2]]))
}

# Determine how many dates selected ---------------
First.Month <- min(MM.Pres_Main$Num_Months)
Second.Month <- max(MM.Pres_Main$Num_Months)
No.Months <- Second.Month - First.Month + 1

Year <- format(mean(MM.Pres_Main$OpDate), "%Y")

First.Month <- format(min(MM.Pres_Main$OpDate), "%B")
Second.Month <- format(max(MM.Pres_Main$OpDate), "%B")

#number of cases ----------------------------------
Total.Cases <- MM.Pres_Main %>%
  group_by(Month) %>%
  summarise(n = n())
```

## Tables and Graphs for slides ---------------------

```{r Slide1}

# Slide 1 ------------------------------------------
#caseload by category

if(No.Months == 1) {                              #if one month is present within M&M dataset create counts for each surgery type
  slide1.data <- MM.Pres_Main %>% 
    group_by(OpCategory, Month) %>%
    summarise(Count = n()) %>% 
    spread(Month, Count) %>%
    adorn_totals("row") %>%                         #add totals to the bottom of the count summary to give total cases per month
    mutate("Percentage" = percent(.[[2]] / Total.Cases[[1, 'n']])) #add percentages for each surgery category as a proportion of the total cases (1 month)
  
  Unique.Category <- unique(slide1.data$OpCategory)
  for (i in seq_along(unique(slide1.data$OpCategory))) {        #loop is used to create a list of operations within each category which are present this month
    x <- MM.Pres_Main %>%                                 #if major OPcategories were not used to create the table in this fashion the table would be too large
      select(OpCategory, OpDescription) %>%
      filter(OpCategory == Unique.Category[i])
    slide1.data[i, "Description"] <- paste(unique(x$OpDescription), collapse = ", ")
  }
  
} else if(No.Months == 2) {                       #if one month is present within M&M dataset create counts for each surgery type
  slide1.data <- MM.Pres_Main %>% 
    group_by(OpCategory, Month) %>%
    summarise(Count = n()) %>%
    arrange(desc(Count)) %>%
    spread(Month, Count) %>%
    adorn_totals("row") %>%                       #add totals to the bottom of the count summary to give total cases per month
    mutate("Percentage" = percent(.[[2]] / Total.Cases[[1, 'n']]),  #add percentages for each surgery category as a proportion of the total cases (2 months)
           "Percentage2" = percent(.[[3]] / Total.Cases[[2, 'n']]))
  

  Unique.Category <- unique(slide1.data$OpCategory)
  for (e in 1:2) {                                  #loop is used to create a list of operations within each category which are present this month
    for (i in seq_along(Unique.Category)) {       #if major OPcategories were not used to create the table in this fashion the table would be too large
      x <- MM.Pres_Main %>%
        select(OpCategory, OpDescription, Num_Months) %>%
        filter(OpCategory == Unique.Category[i] & Num_Months == e)
      slide1.data[i, paste("Description", e)] <- paste(unique(x$OpDescription), collapse = ", ")
    }
  }
  
  slide1.data <- slide1.data[c(1, 2, 4, 6, 3, 5, 7)]
}

slide1.data %>% my_kable()

slide1.plotdata <- MM.Pres_Main %>% 
  group_by(OpCategory, Month) %>%
  summarise(Count = n())

slide1.sum <- sum(slide1.plotdata$Count)

slide1.plotdata %<>% 
  mutate(Percentage = Count/slide1.sum*100) %>% 
  mutate(Percentage_Count = paste(OpCategory,
                                  " - ", 
                                  Count,
                                  " (",
                                  round(Count/sum(slide1.plotdata$Count)*100, 1),
                                  "%)",
                                  sep = ""))

slide1.plot <- ggplot(data = slide1.plotdata, aes(fill = OpCategory, x = Month, y = Percentage)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = `Percentage_Count`), size = 3.5, hjust = 0.5, vjust = 2, position = "stack") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "none") +
  labs(y = "Percentage (%)")

#http://t-redactyl.io/blog/2016/01/creating-plots-in-r-using-ggplot2-part-4-stacked-bar-plots.html
#add text to the columns describing the percentages then probably remove the y axis

slide1.plotdata
slide1.plot
```

```{r Slide2}
# Slide 2 ------------------------------------------
#Caseload historical comparison
slide2.data <- MM.Pres_Main %>%
  group_by(Month) %>%
  summarise("Elective Count" = percentage_func(Op_StatusPOW == 1, n()),
            "Urgent Count" = percentage_func(Op_StatusPOW == 2, n()),
            "Emergency Count" = percentage_func(Op_StatusPOW == 3, n()),
            "Redo" = percentage_func(Op_Incidence > 1, n()), 
            "Mean Age" = mean(Op_Age, na.rm = TRUE), 
            "Median Age" = median(Op_Age, na.rm = TRUE),
            "Mean Logistic EUROSCORE" = mean(EUROScoreLogistic, na.rm = TRUE),
            "Median Logistic EUROSCORE" = median(EUROScoreLogistic, na.rm = TRUE)
            ) %>% 
    rbind(list("Historical (Per Month)",
             "13.2%",
             "2.7%",
             "9.7%",
             "",
             "2.4%",
             "1.1%",
             "",
             "0.4%",
             "0.04%",
             "0.4%",
             "1.1%",
             "1.0%",
             "1.5%",
             "1.1%"))
  
  #t() %>% #transpose the dataframe. Needs fixing.
  #mutate("Percentage" = percent(.[[2]] / Total.Cases[['n']])) %>%   #add percentages needs fixing.
  #mutate("Percentage2" = percent(.[[3]] / Total.Cases[['n']])) 

slide2.data %>% my_kable()
```

```{r Slide3}

# Slide 3 ------------------------------------------
#Caseload by consultant

slide3.data <- MM.Pres_Main %>% 
  group_by(OpConsultant) %>% 
  mutate(Count_monthly = sum(!is.na(Pt_FName))) %>% 
  select(OpConsultant, OpCategory, Count_monthly)

slide3.data %<>%                #count operation categories by consultant
  select(OpConsultant, OpCategory, Count_monthly) %>%
  group_by(OpConsultant, OpCategory) %>%
  summarise(count = percentage_func(n(), mean(Count_monthly, na.rm = T))) %>%
  spread(OpCategory, count) 


fncols <- function(data, cname) {       #function adds op category full of NA if it is missing to create a fixed number of columns 
  add <-cname[!cname%in%names(data)]
  
  if(length(add)!=0) data[add] <- NA
  data
}

slide3.data <- fncols(slide3.data, c("OpConsultant", "CABG","CABG/Other","CABG/Valve", "CABG/Valve/Other", "Other", "Valve", "Valve/Other")) #run function to add missing cols

slide3.data <- slide3.data[, c("OpConsultant", "CABG","CABG/Other", "Valve", "Valve/Other", "CABG/Valve", "CABG/Valve/Other", "Other")] #order the columns


slide3totals.data <- MM.Pres_Main %>%                 #count operation categories by consultant
  select(OpConsultant, OpCategory) %>%
  group_by(OpConsultant, OpCategory) %>%
  summarise(count = n()) %>%
  spread(OpCategory, count) 
slide3.data <- cbind(slide3.data, TOTAL = rowSums(slide3totals.data[2:length(slide3totals.data)], na.rm = TRUE))        #add totals

slide3.data
```

```{r Slide4}

# slide 4 ------------------------------------------
#Mortalities <= 30days

slide4.data1 <- MM.Pres_Main %>% 
  group_by(Month) %>%
  summarise(`Mortalities <= 30` = percentage_func(FU_Death30d, n())) %>%
  mutate("Historical" = rep("1.5%"))       #add historical percentages

slide4.data2 <- MM.Pres_Main %>%
  group_by(Month) %>%
  filter(FU_Death30d == 1) %>%
  select(Pt_LName, OpConsultant, Month, Op_Age, Op_StatusPOW, EUROScoreLogistic, Death_DaysPO, FU_DeathCause1, FU_DeathCause2, FU_DeathNotes)

if (dim(slide4.data2)[1] == 0) {
  slide4.data2[1,] <- NA
}

slide4.data1 %>% my_kable()

slide4.data2 %>% my_kable()
```

```{r Slide5}

# slide 5 ------------------------------------------
#Outpatient Wait day plot + mean/medians table

#Summary Stats Table
slide5.data <- MM.Pres_Main %>%
  filter(Adm_Elective == 1) %>%
  group_by(Month) %>%
  mutate(waitdays = OpDate - ConsultDate) %>%
  select(Month, waitdays) %>%
  summarise(Mean = round(mean(waitdays, na.rm = TRUE), 1), Median = median(waitdays, na.rm = TRUE)) %>%
  rbind(list("Historical", 67.7, 68))

###Variable setup for graphing

#highlight max values for each of the waiting periods
slide5.plotdata <- MM.Pres_Main %>%
  filter(Adm_Elective == 1) %>%
  select(OpConsultant, Pt_LName, OpDate, ConsultDate) %>%
  group_by(OpConsultant) %>%
  mutate(Waitdays = as.numeric(OpDate - ConsultDate))

slide5.plotdata.maxwait <- slide5.plotdata %>%
  group_by(OpConsultant) %>%
  summarise(Max_wait = max(Waitdays))

#Create plot from the data
slide5.plot <- ggplot(slide5.plotdata, aes(Pt_LName, Waitdays)) + 
  geom_col() +
  facet_wrap(~OpConsultant, scales = "free_y") +
  geom_hline(aes(yintercept=90, linetype = "90 Days"), color="#009E73", size = 1) +     #10 day inpatient wait time
  geom_hline(aes(yintercept=slide5.data[[dim(slide5.data)[1], 2]], linetype = "Historical Average"), colour="#D55E00", size = 1) +   #historical mean inpatient wait time
  geom_hline(aes(yintercept=mean(slide5.plotdata$Waitdays, na.rm = TRUE), linetype = "Group Average"), colour="#000000", size = 1)

#Format plot labels and add layout changes
slide5.plot <- slide5.plot + labs(y = "Wait Period (Days)", 
                                  caption = "*Values calculated from Consult Date \n *Consult Date defined as 'First consult where patient is deemed suitable for surgery'") +
  theme_minimal() +
  scale_linetype_manual(name = "", values = c(2, 1, 2), 
                        guide = guide_legend(override.aes = list(color = c("#009E73", "#000000", "#D55E00")))) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom",
        axis.title.y = element_blank()) +
  coord_flip() #flip the axes for readability

slide5.plot
```

```{r Slide6}

# slide 6 ------------------------------------------
#Outpatient Wait >90 day Patients

#summary Stats Table
slide6.data1 <- MM.Pres_Main %>%
  filter(Adm_Elective == 1) %>%
  mutate(Waitdays = OpDate - ConsultDate) %>% 
  group_by(Month) %>%
  summarise("Total Outpatient Cases" = n(),
            ">90 Day Wait" = percentage_func(Waitdays>90, n())) %>% 
  arrange(Month) %>%
  mutate("Historical" = rep("9.7%"))

#Patients With >90 Days Wait
slide6.data2 <- MM.Pres_Main %>%
  filter(Adm_Elective == 1) %>%
  mutate(Waitdays = OpDate - ConsultDate) %>%
  filter(Waitdays > 90) %>%
  arrange(Month, desc(Waitdays)) %>%
  select(Pt_LName, OpConsultant, OpDescription, Month, Waitdays, "Pre-OP Comments" = PreOp_Comments)

if(nrow(slide6.data2)==0){
  slide6.data2 %<>% rbind(rep(NA))
}

slide6.data1 %>% my_kable()
slide6.data2 %>% my_kable()
```

```{r Slide7}

# slide 7 ------------------------------------------
#Inpatient Wait day plot + mean/medians table

#Summary Stats Table
slide7.data <- MM.Pres_Main %>%
  filter(Adm_Elective == 0) %>%
  group_by(Month) %>%
  mutate(waitdays = OpDate - AdmDate) %>%
  select(Month, waitdays) %>%
  summarise(Mean = round(mean(waitdays, na.rm = TRUE), 1), Median = median(waitdays, na.rm = TRUE)) %>%
  rbind(list("Historical", 5.8, 4))

###Variable setup for graphing

#highlight max values for each of the waiting periods
slide7.plotdata <- MM.Pres_Main %>%
  filter(Adm_Elective == 0) %>%
  select(OpConsultant, Pt_LName, OpDate, AdmDate) %>%
  group_by(OpConsultant) %>%
  mutate(Waitdays = as.numeric(OpDate - AdmDate))

#highlight cases of interest on the graph 
slide7.plotdata.maxwait <- slide7.plotdata %>%
  group_by(OpConsultant) %>%
  summarise(Max_wait = max(Waitdays))

#Create plot from the data
slide7.plot <- ggplot(slide7.plotdata, aes(Pt_LName, Waitdays)) + 
  geom_col() +
  facet_wrap(~OpConsultant, scales = "free_y") +
  geom_hline(aes(yintercept=10, linetype = "10 Days"), colour="#009E73", size = 1) +     #10 day inpatient wait time
  geom_hline(aes(yintercept=slide7.data[[dim(slide7.data)[1], 2]], linetype = "Historical Average"), colour="#D55E00", size = 1) +  #historical mean inpatient wait time
  geom_hline(aes(yintercept=mean(slide7.plotdata$Waitdays, na.rm = TRUE), linetype = "Group Average"), colour="#000000", size = 1) #group average
  
#Format plot labels and add layout changes
slide7.plot <- slide7.plot + labs(x = "", y = "Wait Period (Days)", 
                                  caption = "*Values calculated from Admission Date") +
  theme_minimal() +
  scale_linetype_manual(name = "", values = c(2, 1, 2), 
                        guide = guide_legend(override.aes = list(color = c("#009E73", "#000000", "#D55E00")))) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom") +
  coord_flip() #flip the axes for readability

slide7.data %>% my_kable()
slide7.plot
```

```{r Slide8}

# slide 8 ------------------------------------------
#Outpatient Wait >10 day Patients

#summary Stats Table
slide8.data1 <- MM.Pres_Main %>%
  filter(Adm_Elective == 0) %>%
  mutate(Waitdays = OpDate - ConsultDate) %>% 
  group_by(Month) %>%
  summarise("Total Inpatient Cases" = n(),
            ">10 Day Wait" = paste(sum(Waitdays>10, na.rm = T), ' (', percent(sum(Waitdays>10, na.rm = T)/n()), ')', sep = "")) %>%
  arrange(Month) %>%
  mutate("Historical" = rep("6.8%"))

#Patients With >10 Days Wait
slide8.data2 <- MM.Pres_Main %>%
  filter(Adm_Elective == 0) %>%
  mutate(Waitdays = OpDate - ConsultDate) %>%
  filter(Waitdays > 10) %>%
  arrange(Month, desc(Waitdays)) %>%
  select(Pt_LName, OpConsultant, OpDescription, Month, Waitdays, "Pre-OP Comments" = PreOp_Comments)

slide8.data1 %>% my_kable()
slide8.data2 %>% my_kable()
```

```{r Slide9}

# slide 9 ------------------------------------------
# ICU Stay (days)

#Summary Stats Table
slide9.data <- MM.Pres_Main %>%
  group_by(Month) %>%
  select(Month, ICUDays, ICUReqDays) %>%
  summarise(Mean = round(mean(ICUDays, na.rm = TRUE), 1), Median = round(median(ICUDays, na.rm = TRUE), 1))

slide9.data$Month <- as.character(slide9.data$Month)
slide9.data <- slide9.data %>% 
  rbind(list("Historical", 2.7, 1.9))



#ICU bedblock data
ICUbedblock <- MM.Pres_Main %>%
  mutate(BedBlock = (ICUDays - ICUReqDays)) %>%
  select(Pt_LName, Pt_FName, ICUReqDays, ICUDays, BedBlock) %>%
  filter(BedBlock > 2) %>%
  summarise(`Number of Patients with BedBlock > 2 hours` = sum(!is.na(BedBlock)),
            `BedBlock Mean (per patient)` = round(mean(BedBlock, na.rm = TRUE),digits = 1),
            `Bedblock Median (per patient)` = round(median(BedBlock, na.rm = TRUE)),
            maxbedblock = max(BedBlock, na.rm = TRUE)
            )

###Variable setup for graphing
#fundamental plotting data
slide9.plotdata <- MM.Pres_Main %>%
  select(Pt_LName, OpConsultant, Month, ICUDays, ICUReqDays, OpDescription, AdmConsultantInitials) %>%
  arrange(Month, OpConsultant)

slide9.plotdata %<>% 
  mutate(Pt_LName = paste(OpDescription, " (", AdmConsultantInitials, ") ", Pt_LName)) %>% 
  mutate(BedBlock = (ICUDays - ICUReqDays)) %>% 
  mutate(`ICUDays label` = ddays(ICUDays))          #ddays lubridate function converts to a duration data type which displays duration in appropriate format in brackets. Here i just need to take the bracket section

slide9.plotdata$`ICUDays label` <- as.character(slide9.plotdata$`ICUDays label`) 
slide9.plotdata$`ICUDays label` <- gsub("^.*s ", "", slide9.plotdata$`ICUDays label`)



slide9.plotdata$Pt_LName <- factor(slide9.plotdata$Pt_LName, levels = (slide9.plotdata$Pt_LName[order(slide9.plotdata$ICUDays)]))


#Create plot from the data
slide9.plot <- ggplot(slide9.plotdata, aes(Pt_LName, ICUDays)) + 
  geom_col(fill = "#D10202") +
  geom_col(aes(y = ICUReqDays), fill = "#D16103") +
  facet_wrap(~Month, scales = "free_y") +
  geom_hline(aes(yintercept= 3, linetype = "3 Days"), colour="#009E73", size = 1) +     #3 day ICU Stay
  geom_hline(aes(yintercept= slide9.data[[dim(slide9.data)[1], 2]], linetype = "Historical Average"), colour="#D55E00", size = 1) +  #historical mean inpatient wait time
  geom_hline(aes(yintercept= mean(slide9.plotdata[["ICUDays"]], na.rm = TRUE), linetype = "Group Average"), colour="#000000", size = 1) #group average
  
#Format plot labels and add layout changes
slide9.plot <- slide9.plot + labs(x = "", y = "ICU Length of Stay (Days)") +
  theme_minimal() +
  scale_linetype_manual(name = "", values = c(2, 1, 2), 
                        guide = guide_legend(override.aes = list(color = c("#009E73", "#000000", "#D55E00")))) +
  geom_text(aes(label = `ICUDays label`), position=position_dodge(width=0.5), hjust=-0.05) +
  scale_y_continuous(limits = c(0, max(slide9.plotdata[["ICUDays"]], na.rm = T) + 1.5)) +
  # geom_text(aes()) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom") +
  coord_flip() #flip the axes for readability
slide9.plot
```

```{r ICU Timeintervals}
IcuTimelineData <- MM.Pres_Main


IcuTimelineData[IcuTimelineData$Pt_LName == 'NEAL, H',"DischargeDate"] = as.Date('2019-02-07')
IcuTimelineData[IcuTimelineData$Pt_LName == 'LOVETT, S',"AdmDate"] = as.Date('2019-01-01')

IcuTimelineData %<>% mutate(Pt_LName = paste(OpDescription, " (", AdmConsultantInitials, ") ", Pt_LName))

IcuTimelineData$Pt_LName <- factor(IcuTimelineData$Pt_LName, levels = (IcuTimelineData$Pt_LName[order(IcuTimelineData$OpDate)]))

Min.Date <- min(MM.Pres_Main$AdmDate, na.rm = T)
Max.Date <- max(MM.Pres_Main$DischargeDate, na.rm = T)

weekenddates <- seq(as.Date(Min.Date),as.Date(Max.Date),by = 1)
weekenddates <- weekenddates[weekdays(weekenddates) %in% c('Saturday','Sunday')]

#weekend highlight function
# test <- data.frame(DATE=seq(from = min(IcuTimelineData$AdmDate),
#                             to = max(IcuTimelineData$DischargeDate),
#                             by = "day"))
# 
# test$weekend <- weekdays(test$DATE) %in% c("Saturday", "Sunday")
# test %<>% filter(weekend == T)
# 
#   geom_segment(data = test, aes(x=DATE, xend = DATE+2, y = -Inf, yend = Inf), fill="yellow") +

ggplot(IcuTimelineData, aes(y = Pt_LName)) +
  # geom_hline(aes(yintercept = Pt_LName, colour = OpConsultant)) +
  geom_vline(xintercept = weekenddates, alpha =0.2, size = 5) +
  geom_segment(aes(x = AdmDate, xend = DischargeDate, y = Pt_LName, yend = Pt_LName, linetype = "Total Stay"), colour = "#000000") + #total stay duration (black)
  geom_segment(aes(x = PO_ICUAdmDt, xend = PO_ICUOutDt, y = Pt_LName, yend = Pt_LName, linetype = "ICU Bed Block Duration"), size = 5, colour = "#D10202") + #total ICU stay - effectively displays bed block (red)
  geom_segment(aes(x = PO_ICUAdmDt, xend = PO_RFWDt, y = Pt_LName, yend = Pt_LName, linetype='ICU Stay (Ready for Discharge)'), size = 5, colour = "#D16103") + #ICU stay until ready for discharge(orange)
  geom_segment(aes(x = OpDate, xend = OpDate + 0.5, y = Pt_LName, yend = Pt_LName, linetype = "Operation"), colour = "#4E84C4", size = 5) + 
  geom_segment(aes(x = AdmDate, xend = AdmDate + 0.1, y = Pt_LName, yend = Pt_LName), size = 5, show.legend = TRUE) +
  geom_segment(aes(x = DischargeDate, xend =DischargeDate+0.1, y = Pt_LName, yend = Pt_LName), size = 5) +
  scale_x_date(date_breaks = "3 days", labels = date_format("%d\n%b"), date_minor_breaks = "1 day") +
  scale_linetype_manual(name = "", values = c(1, 1, 1, 1), 
                        guide = guide_legend(override.aes = list(color = c("#D10202", "#D16103", "#4E84C4", "#000000")))) +
  facet_wrap(~Month, scales = "free_y") +
  labs(caption = "*x-axis major ticks =  3 day intervals \n *x-axis minor ticks = 1 day intervals \n *Weekends highlighted in grey") +
  theme_minimal() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(colour = "#000000", size = 1, linetype = "solid"),
        panel.grid.major.y = element_blank(),
        legend.position = "bottom", 
        legend.title = element_blank())

# "Admission Duration"
# , "Admission Duration" = "#000000"
#add consultant and patient names or highlight with colour coding
#add weekends in gray background
#add infection dates
#highlight deaths
#show bed block as darker red for the ICU segments
```


```{r Slide10}

# slide 10 ------------------------------------------
# Prolonged ICU Stay (3 days)

#ICU bedblock data        (repeated for clarity)
slide10.data1 <- MM.Pres_Main %>% 
  group_by(Month) %>%
  mutate(BedBlock = (ICUDays - ICUReqDays)) %>%
  select(Pt_LName, Pt_FName, Month, ICUReqDays, ICUDays, BedBlock) %>%
  filter(ICUReqDays > 0) %>%
  summarise("LOS > 3 Days" = percentage_func(ICUDays>3, n()),
            "Historical" = rep("6.8%"),
            "Mean Patient Bed Block (Hours)" = mean(BedBlock, na.rm = TRUE)*24,
            "Median Patient Bed Block (Hours)" = median(BedBlock, na.rm = TRUE)*24,
            "Max Patient Bed Block (Days)" = max(BedBlock, na.rm = TRUE)
            )

#Patients With >90 Days Wait
slide10.data2 <- MM.Pres_Main %>%
  filter(ICUDays > 3) %>%
  arrange(Month, desc(ICUDays)) %>%
  select(Pt_LName, OpConsultant, OpCategory, Month, ICUReqDays, ICUDays, "Pre-OP Comments" = PreOp_Comments)


```

```{r Slide11}

# slide 11 ------------------------------------------
# Post-OP LOS (days)

#Summary Stats Table
slide11.data <- MM.Pres_Main %>%
  mutate("Post-OP LOS" = DischargeDate - OpDate) %>%
  select(Month, `Post-OP LOS`) %>%
  group_by(Month) %>%
  summarise(Mean = round(mean(`Post-OP LOS`, na.rm = TRUE), 1), Median = round(median(`Post-OP LOS`, na.rm = TRUE), 1)) %>%
  rbind(list("Historical", 10.1, 7))


###Variable setup for graphing
#fundamental plotting data
slide11.plotdata <- MM.Pres_Main %>%
  mutate("Post-OP LOS" = as.numeric(DischargeDate - OpDate)) %>%
  select(Pt_LName, OpConsultant, Month, "Post-OP LOS") %>%
  arrange(Month, OpConsultant)

#Create plot from the data
slide11.plot <- ggplot(slide11.plotdata, aes(Pt_LName, `Post-OP LOS`)) + 
  geom_col() +
  facet_wrap(~Month, scales = "free_y") +
  geom_hline(aes(yintercept= 10, linetype = "10 Days"), colour="#009E73", size = 1) +     #10 day post op Stay
  geom_hline(aes(yintercept= slide11.data[[dim(slide11.data)[1], 2]], linetype = "Historical Average"), colour="#D55E00", size = 1) +  #historical mean inpatient wait time
  geom_hline(aes(yintercept= mean(slide11.plotdata[["Post-OP LOS"]], na.rm = TRUE), linetype = "Group Average"), colour="#000000", size = 1) #group average

#Format plot labels and add layout changes
slide11.plot <- slide11.plot + 
  labs(x = "",
       y = "Post-OP Length of Stay (Days)") +
  theme_minimal() +
  scale_linetype_manual(name = "", values = c(2, 1, 2), 
                        guide = guide_legend(override.aes = list(color = c("#009E73", "#000000", "#D55E00")))) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom") +
  coord_flip() #flip the axes for readability


```

```{r Slide12}

# slide 12 ------------------------------------------
# Prolonged Post-OP LOS (>10 days)

slide12.data1 <- MM.Pres_Main %>% 
  mutate("Post-OP LOS" = DischargeDate - OpDate) %>%
  group_by(Month) %>%
  summarise("Count of Prolonged Stays (>10 Days)" = percentage_func(`Post-OP LOS`>10, n()),
            "Historical" = rep("26.1%"))

#Patients With >10 Days Wait
slide12.data2 <- MM.Pres_Main %>%
  mutate("Post-OP LOS" = DischargeDate - OpDate) %>%  
  filter(`Post-OP LOS` > 10) %>%
  arrange(Month, desc(`Post-OP LOS`)) %>%
  select(Pt_LName, OpConsultant, OpCategory, Month, `Post-OP LOS`, "Post-OP Comments" = PO_Comments)
```

```{r Slide13}

# slide 13 ------------------------------------------
# Post-op AMI or Cardiac Arrest

slide13.data1 <- MM.Pres_Main %>% 
  select(Month, PO_AMI, PO_CardArrest) %>%
  group_by(Month) %>%
  summarise("AMI" = paste(sum(PO_AMI), percent(sum(PO_AMI, na.rm = TRUE)/n()), collapse = " "),
            "Post-OP Cardiac Arrest" = paste(sum(PO_CardArrest), percent(sum(PO_CardArrest, na.rm = TRUE)/n()), collapse = " ")) %>%
  rbind(list("Historical (Per Month)", "0.4%", "1.6%"))

slide13.data2 <- MM.Pres_Main %>%
  mutate("Post-OP LOS" = DischargeDate - OpDate) %>%
  filter(`PO_AMI` == 1 | `PO_CardArrest` == 1) %>%
  arrange(Month, desc(PO_AMI), desc(PO_CardArrest)) %>%
  select(Pt_LName, OpConsultant, OpCategory, Month, `Post-OP Cardiac Arrest` = PO_CardArrest,`Post-OP LOS`, "Pre-OP Comments" = PO_Comments)

if(nrow(slide13.data2)==0){
  slide13.data2[1,] <- NA
}

slide13.data1 %>% my_kable()
slide13.data2 %>% my_kable()
```

```{r Slide14}

# slide 14 ------------------------------------------
# IABP Use

slide14.data1 <- MM.Pres_Main %>% 
  select(Month, IABP, IABP_When) %>%
  group_by(Month, IABP_When) %>%
  summarise("Count" = n()) %>%
  filter(IABP_When != 0) %>%
  spread(Month, Count) %>%
  adorn_totals("row")

while(nrow(slide14.data1)<4) {
  if(No.Months == 2 & is.element('Pre-Op', slide14.data1[['IABP_When']]) == FALSE) { #this sequence adds any missing rows for visual purposes (2 month data)
    slide14.data1 <- rbind(slide14.data1, c('Pre-Op', 0, 0))
  } else if(is.element('Intra-Op', slide14.data1[['IABP_When']]) == FALSE) {
    slide14.data1 <- rbind(slide14.data1, c('Intra-Op', 0, 0))
  } else if(is.element('Post-Op', slide14.data1[['IABP_When']]) == FALSE) {
    slide14.data1 <- rbind(slide14.data1, c('Post-Op', 0, 0))
  }


  if(No.Months == 1 & is.element('Pre-Op', slide14.data1[['IABP_When']]) == FALSE) { #this sequence adds any missing rows for visual purposes (1 month data)
    slide14.data1 <- rbind(slide14.data1, c('Pre-Op', 0))
  } else if(is.element('Intra-Op', slide14.data1[['IABP_When']]) == FALSE) {
    slide14.data1 <- rbind(slide14.data1, c('Intra-Op', 0))
  } else if(is.element('Post-Op', slide14.data1[['IABP_When']]) == FALSE) {
    slide14.data1 <- rbind(slide14.data1, c('Post-Op', 0))
  }
}

IABP_when_order <- c("Pre-Op", "Intra-Op", "Post-Op", "Total") #create desired order for rows
slide14.data1 %<>%
  slice(match(IABP_when_order, IABP_When))                 #add match dataframe to the ordered vector

slide14.data1$`Historical (per month)` <- (c("91.3%", "2.6%", "6.1%", "11.2%")) #add historical data for comparison

if(No.Months == 2) {
  slide14.data1 %<>% mutate("Percentage" = percent(as.numeric(.[[2]]) / as.numeric(.[[4, 2]])),  #add percentages for each surgery category as a proportion of the total cases (2 months)
                            "Percentage2" = percent(as.numeric(.[[3]]) / as.numeric(.[[4, 3]])))

  slide14.data1 <- slide14.data1[, c(1, 2, 5, 3, 6, 4)] #reorder the columns
} 

if(No.Months == 1) {
  slide14.data1 %<>% mutate("Percentage" = percent(as.numeric(.[[2]]) / as.numeric(.[[4, 2]])))  #add percentages for each surgery category as a proportion of the total cases (1 months)
  
  slide14.data1 <- slide14.data1[, c(1, 2, 4, 3)]
}  




#patients with IABP insertions
slide14.data2 <- MM.Pres_Main %>%                #count operation categories by consultant
  select(Pt_LName, OpConsultant, OpDescription,  Month, IABP_Indication, IABP_When) %>%
  group_by(Month) %>%
  filter(IABP_Indication != 0)

slide14.data1 %>% my_kable()
slide14.data2 %>% my_kable()
```

```{r Slide15}

# slide 15 ------------------------------------------
# Blood Transfusions 

slide15.data2 <- MM.Pres_Main %>%
  group_by(OperationID) %>% 
  mutate(Bld_Tot_All = sum(Bld_Tot_RBC, Bld_Tot_FFP, Bld_Tot_Plt, Bld_Tot_Cryo, Bld_Tot_FVIIa_mg, Bld_Tot_PTX)) %>% 
  select(OperationID, Month, Pt_LName, OpCategory, OpConsultantInitials, Bld_Tot_RBC, Bld_Tot_FFP, Bld_Tot_Plt, Bld_Tot_Cryo, Bld_Tot_FVIIa_mg, Bld_Tot_PTX, Bld_Tot_All) %>% 
  mutate(`Recieved_Bld_Prod` = if_else(Bld_Tot_All > 0, 1, 0),
         `RBC > 4 U` = if_else(Bld_Tot_RBC > 4, 1, 0),
         `RBC > 15 U` = if_else(Bld_Tot_RBC > 15, 1, 0),
         `Any Blood Prod > 15 U` = if_else(Bld_Tot_All > 15, 1, 0)) #set up counts based upon transfusion conditions for summary in next lines

slide15.data1 <- slide15.data2 %>%  
  group_by(Month) %>% 
  summarise(`Recieved Blood Product` = paste(sum(`Recieved_Bld_Prod`, na.rm = T), ' (', round(sum(`Recieved_Bld_Prod`, na.rm = T)/n()*100, 2),'%)', sep = ""),
            `RBC > 4 Units` = paste(sum(`RBC > 4 U`, na.rm = T), ' (', round(sum(`RBC > 4 U`, na.rm = T)/n()*100, 2),'%)', sep = ""),
            `RBC > 15 Units` = paste(sum(`RBC > 15 U`, na.rm = T), '(', round(sum(`RBC > 15 U`, na.rm = T)/n()*100, 2), '%)', sep = ""),
            `Any Blood Prod > 15 Units` = paste(sum(`Any Blood Prod > 15 U`, na.rm = T), ' (', round(sum(`Any Blood Prod > 15 U`, na.rm = T)/n()*100, 2), '%)', sep = "")) %>%
  rbind(list("Historical (Per Month)", "(61.8%)", "(13.1%)", "(0.9%)", "(6.5%)"))

slide15.data2 %<>% 
  filter(Bld_Tot_All >= 10) %>% 
  arrange(Month, desc(Bld_Tot_All)) %>% 
  select(-one_of("OperationID", "Recieved_Bld_Prod", "RBC > 4 U", "RBC > 15 U", "Any Blood Prod > 15 U"))

slide15.data2 <- slide15.data2[, 2:length(slide15.data2)]

slide15.data1 %>% my_kable()
```

```{r Slide16}

# slide 16 ------------------------------------------
# Reintubation & Return to ICU

slide16.data1 <- MM.Pres_Main %>% 
  select(Month, PO_Reintubation, PO_ReturnICU) %>%
  group_by(Month) %>% 
  summarise(`Return to ICU` = paste(sum(PO_ReturnICU, na.rm = T), ' (', percent(sum(PO_ReturnICU, na.rm = T)/n()), ')', sep = ""),
            `ReIntubation` = paste(sum(PO_Reintubation, na.rm = T), ' (', percent(sum(PO_Reintubation, na.rm = T)/n()), ')', sep = "")) %>% 
  rbind(list("Historical (Per Month)", "2.0%", "2.2%"))

slide16.data2 <- MM.Pres_Main %>% 
  filter(PO_Reintubation == 1) %>% 
  arrange(Month) %>% 
  mutate(ReIntubated = paste(Pt_LName, ' (', OpConsultantInitials, ') ', OpCategory, sep = ''),
         "Post-OP Issues" = paste(if_else(PO_RTT == 1, "Return to Theatre", ""), sep = ", ")) %>% 
  select(ReIntubated, `Post-OP Issues`)

slide16.data3 <- MM.Pres_Main %>% 
  filter(PO_ReturnICU == 1) %>% 
  arrange(Month) %>% 
  mutate(`Return to ICU` = paste(Pt_LName, ' (', OpConsultantInitials, ') ', OpCategory, sep = ''),
         "Post-OP Issues" = paste(if_else(PO_RTT == 1, "Return to Theatre", ""), sep = ", ")) %>% 
  select(`Return to ICU`, Month, `Post-OP Issues`)
  
slide16.data1 %>% my_kable()
slide16.data2 %>% my_kable()
slide16.data3 %>% my_kable()
```

```{r Slide17}

# slide 17 ------------------------------------------
# Return to Theatre

slide17.data1 <- MM.Pres_Main %>% 
  group_by(Month) %>% 
  summarise(`Return to Theatre (Total Patients)` = paste(sum(PO_RTT, na.rm = T), ' (', percent(sum(PO_RTT, na.rm = T)/n()), ')', sep = "")) %>% 
  rbind(list("Historical (Per Month)", "5.1%"))

slide17.data2 <- MM.RTT

slide17.data1 %>% my_kable()
slide17.data2 %>% my_kable()
```

```{r Slide18}

# slide 18 ------------------------------------------
# Infections

if (nrow(MM.Inf) != 0) {
  slide18.data1 <- MM.Inf %>% 
    group_by(Month) %>% 
    summarise(`Total Patients` = paste(n(), ' (', percent(n() / min(TotalCasesMonthly)), ')', sep = "")) %>% 
    rbind(list("Historical (Per Month)", rep("10.2%")))
  
  slide18.data2 <- MM.Inf %>%
    group_by(Month) %>%
    summarise("Superficial Sternum" = paste(sum(if_else(InfSite=="Sternum" & AccessInfDepth=="Superficial", 1, 0)), ' (', percent(sum(if_else(InfSite=="Sternum" & AccessInfDepth=="Superficial", 1, 0)) / min(TotalCasesMonthly)), ')', sep = ""),
              "Deep Sternum" = paste(sum(if_else(InfSite=="Sternum" & AccessInfDepth=="Deep", 1, 0)), ' (', percent(sum(if_else(InfSite=="Sternum" & AccessInfDepth=="Deep", 1, 0)) / min(TotalCasesMonthly)), ')', sep = ""),
              "Leg" = paste(sum(InfSite=="Leg"), ' (', percent(sum(InfSite=="Leg") / min(TotalCasesMonthly)), ')', sep = ""),
              "Radial" = paste(sum(InfSite=="Radial"), ' (', percent(sum(InfSite=="Radial") / min(TotalCasesMonthly)), ')', sep = ""),
              "IABP/Cannula" = paste(sum(InfSite=="IABP/Cannula"), ' (', percent(sum(InfSite=="IABP/Cannula") / min(TotalCasesMonthly)), ')', sep = ""),
              "Septicaemia" = paste(sum(InfSite=="Septicaemia"), ' (', percent(sum(InfSite=="Septicaemia") / min(TotalCasesMonthly)), ')', sep = ""),
              "UTI" = paste(sum(InfSite=="UTI"), ' (', percent(sum(InfSite=="UTI") / min(TotalCasesMonthly)), ')', sep = ""),
              "Pneumonia" = paste(sum(InfSite=="Pneumonia/LRTI"), ' (', percent(sum(InfSite=="Pneumonia/LRTI") / min(TotalCasesMonthly)), ')', sep = ""),
              "MRSA" = paste(sum(InfSite=="MRSA"), ' (', percent(sum(InfSite=="MRSA") / min(TotalCasesMonthly)), ')', sep = ""),
              "Sterile Sternal Dehiscence" = paste(sum(InfSite=="Sterile Sternal Dehiscence"), ' (', percent(sum(InfSite=="Sterile Sternal Dehiscence") / min(TotalCasesMonthly)), ')', sep = ""),
              "Other" = paste(sum(InfSite=="Other"), ' (', percent(sum(InfSite=="Other") / min(TotalCasesMonthly)), ')', sep = "")
              ) %>%
    rbind(list("Historical (Per Month)", "0.7%", "0.3%", "1.4%", "0.0%", "0.2%", "0.5%", "1.2%", "3.0%", "1.8%", "0.4%", "-"))
} else {
  slide18.data1 <- MM.Pres_Main %>% 
    group_by(Month) %>% 
    summarise(`Total Patients` = paste("0", ' (0%)', sep = "")) %>% 
    rbind(list("Historical (Per Month)", rep("10.2%")))
  
  slide18.data2 <- MM.Pres_Main %>% 
    group_by(Month) %>% 
    summarise("Superficial Sternum" = 0,
              "Deep Sternum" = 0,
              "Leg" = 0,
              "Radial" = 0,
              "IABP/Cannula" = 0,
              "Septicaemia" = 0,
              "UTI" = 0,
              "Pneumonia" = 0,
              "MRSA" = 0,
              "Sterile Sternal Dehiscence" = 0,
              "Other" = 0) %>% 
    rbind(list("Historical (Per Month)", "0.7%", "0.3%", "1.4%", "0.0%", "0.2%", "0.5%", "1.2%", "3.0%", "1.8%", "0.4%", "-"))
  }

slide18.data1 %>% my_kable()
slide18.data2 %>% my_kable()
```

```{r Slide19}

# slide 19 ------------------------------------------
# Infection Details

slide19.data1 <- MM.Inf
slide19.data1$AccessInfDepth[is.na(slide19.data1$AccessInfDepth)==T] = ""
slide19.data1$Inf_SiteSpecify[is.na(slide19.data1$Inf_SiteSpecify)==T] = ""
slide19.data1$DonorSiteDepth[is.na(slide19.data1$DonorSiteDepth)==T] = ""
slide19.data1$Inf_Organism[is.na(slide19.data1$Inf_Organism)==T] = ""


slide19.data1 %<>% 
  arrange(Month) %>% 
  mutate(InfSite = paste(InfSite, AccessInfDepth, DonorSiteDepth, Inf_SiteSpecify)) %>% 
  select(`Patient Details`, Month, InfSite, Organism = Inf_Organism)

slide19.data1 %>% my_kable()
```

```{r Slide20}

# slide 20 ------------------------------------------
# Atrial Fibrilation and Arrythmias

slide20.data1 <- MM.Pres_Main %>%  
  group_by(Month) %>% 
  summarise(`New AF` = paste(sum(PO_AF, na.rm = T), ' (', percent(sum(PO_AF, na.rm = TRUE) / n()), ')', sep = ""),
            `Temporary Pacing` = paste(sum(PO_TempPacing, na.rm = T), ' (', percent(sum(PO_TempPacing, na.rm = TRUE) / n()), ')', sep = ""),
            `Cardioversion` = paste(sum(PO_DCCV, na.rm = T), ' (', percent(sum(PO_DCCV, na.rm = TRUE) / n()), ')', sep = ""),
            `PPM Inserted` = paste(sum(PO_PPMforHB, na.rm = T)+sum(PO_PPMforBrady, na.rm = T), ' (', percent((sum(PO_PPMforHB, na.rm = T)+sum(PO_PPMforBrady, na.rm = T)) / n()), ')', sep = ""),
            ) %>% 
  rbind(list("Historical (Per Month)", "23.8%", "3.4%", "4.5%", "3.7%"))

slide20.data1 %>% my_kable()
```

```{r Slide21}

# slide 21 ------------------------------------------
# Neurological Events

slide21.data1 <- MM.Pres_Main %>% 
  group_by(Month) %>% 
  summarise(`Stroke Permanent (>72 hrs)` = paste(sum(PO_Stroke, na.rm = T), ' (', percent(sum(PO_Stroke, na.rm = T) / n()), ')', sep = ""),
            `Stroke Transient (<72 hrs)` = paste(sum(PO_TIA, na.rm = T), ' (', percent(sum(PO_TIA, na.rm = T) / n()), ')', sep = ""),
            `Continuous Coma (>24 hrs)` = paste(sum(PO_COMA, na.rm = T), ' (', percent(sum(PO_COMA, na.rm = T) / n()), ')', sep = "")
  ) %>% 
  rbind(list("Historical (Per Month)", "0.6%", "0.5%", "0.1%"))

slide21.data2 <- MM.Pres_Main %>% 
  filter(PO_Stroke == 1 | PO_TIA == 1 | PO_COMA == 1) %>% 
  mutate(`Return to ICU` = paste(Pt_LName, ' (', OpConsultantInitials, ') ', OpCategory, sep = ''),
       "Post-OP Issues" = paste(if_else(PO_RTT == 1, "Return to Theatre", ""), sep = ", ")) %>% 
  select(Month, `Return to ICU`, OpDescription, PO_Comments)

slide21.data1 %>% my_kable()
slide21.data2 %>% my_kable()
```

```{r Slide22}
# slide 22 ------------------------------------------
# Other Post-OP Complications

slide22.data1 <- MM.Pres_Main %>% 
  group_by(Month) %>% 
  summarise(`Pulmonary:` = "",
            `>24hrs Ventilation` = paste(sum(`PO_Vent>24hr`, na.rm = T), ' (', percent(sum(`PO_Vent>24hr`, na.rm = T) / n()), ')', sep = ""),
            `Pneumothorax` = paste(sum(PO_PTX, na.rm = T), ' (', percent(sum(PO_PTX, na.rm = T) / n()), ')', sep = ""),
            `Pleural Eff req. Drain` = paste(sum(PO_PleralEff, na.rm = T), ' (', percent(sum(PO_PleralEff, na.rm = T) / n()), ')', sep = ""),
            `Renal:` = "",
            `New Renal Failure` = paste(sum(PO_NewRenalFx, na.rm = T), ' (', percent(sum(PO_NewRenalFx, na.rm = T) / n()), ')', sep = ""),
            `New Dialysis` = paste(sum(PO_Dialysis, na.rm = T), ' (', percent(sum(PO_Dialysis, na.rm = T) / n()), ')', sep = ""),
            `Other:` = "",
            `Acute Limb Ischaemia` = paste(sum(PO_ALI, na.rm = T), ' (', percent(sum(PO_ALI, na.rm = T) / n()), ')', sep = ""),
            `Aortic Disection` = paste(sum(PO_AortaDiscet, na.rm = T), ' (', percent(sum(PO_AortaDiscet, na.rm = T) / n()), ')', sep = ""),
            `DVT` = paste(sum(PO_DVT, na.rm = T), ' (', percent(sum(PO_DVT, na.rm = T) / n()), ')', sep = ""),
            `Anti-coagulant Complication` = paste(sum(PO_Anticoag, na.rm = T), ' (', percent(sum(PO_Anticoag, na.rm = T) / n()), ')', sep = ""),
            `GIT Complictaion` = paste(sum(PO_GITCompl, na.rm = T), ' (', percent(sum(PO_GITCompl, na.rm = T) / n()), ') ', str_c(str_replace_na(PO_GITType[!is.na(PO_GITType)]), collapse = ", "), sep = ""),
            `Cardiogenic Shock` = paste(sum(PO_CardioShock, na.rm = T), ' (', percent(sum(PO_CardioShock, na.rm = T) / n()), ')', sep = ""),
            `Multi-Organ Dysfunction` = paste(sum(PO_MODS, na.rm = T), ' (', percent(sum(PO_MODS, na.rm = T) / n()), ')', sep = "")
  ) %>% 
  rbind(list("Historical (Per Month)",
             "",
             "13.2%",
             "2.7%",
             "9.7%",
             "",
             "2.4%",
             "1.1%",
             "",
             "0.4%",
             "0.04%",
             "0.4%",
             "1.1%",
             "1.0%",
             "1.5%",
             "1.1%"))

slide22.data1 %>% my_kable()
```

```{r Slide23}

# slide 23 ------------------------------------------
# Readmitted

slide23.data1 <- MM.Pres_Main %>%
  group_by(Month) %>% 
  summarise(`Readmitted <= 30 Days` = paste(sum(FU_ReAdm30d, na.rm = T), ' (', percent(sum(FU_ReAdm30d, na.rm = T)/n(), accuracy = 0.1), ')', sep = "")) %>% 
  rbind(list("Historical (Per Month)", "3.1%"))
  
slide23.data2 <- MM.ReAdm

slide23.data2 %>% my_kable()
```


```{r slide_variables}
#Date caption for title
if(No.Months == 1){
  captitle <- paste(First.Month, format(mean(MM.Pres_Main$OpDate), "%Y"), sep = " ")
} else if(No.Months == 2){
  captitle <- paste(First.Month, "and", Second.Month, Year, sep = " ")
}

doc <- read_pptx("Powerpoint_Templates/piktochart.pptx")

#footer for the presentation
myftr<-"RoryDenham R to PowerPoint"


# Build the Slide Deck ------------------------
read_pptx("Powerpoint_Templates/piktochart.pptx") %>%
  layout_summary()

read_pptx("Powerpoint_Templates/piktochart.pptx") %>% 
  layout_properties(layout = "Title Slide")

read_pptx("Powerpoint_Templates/piktochart.pptx") %>%
  layout_properties(layout = "Content with Side Graph")

read_pptx("Powerpoint_Templates/piktochart.pptx") %>%
  layout_properties(layout = "Double Table Small Title")

annotate_base(path = "Powerpoint_Templates/piktochart.pptx", output_file = "annotated_layout_base_edit.pptx")

slide.layouts(doc, 'Content with Side Graph')

```


```{r Build_Deck}

doc <- read_pptx("Powerpoint_Templates/piktochart.pptx") %>%
  # Title Slide
  # image size needs fixing
  add_slide(layout="Title Slide", master="Office Theme") %>%
  ph_with_text(type = "ctrTitle", str = "Cardiac Surgery Data Review\n&\nMorbidity and Mortality") %>% 
  ph_with_text(type = "subTitle", str = captitle) %>% 
  ph_with_text(type = "ftr", str = myftr) %>%
  
  # Slide 1 - Caseload:
  add_slide(layout = "Content with Side Graph", master = "Office Theme") %>% 
  ph_with_text(type = "title", index=1, str = "Caseload") %>%
  ph_with_table(type = "body", index=2, value = slide1.data) %>%
  ph_with_gg(type = "body", index=3, value = slide1.plot) %>% 
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "1" ) %>%
  ph_with_text(type = "dt", str = format(Sys.Date(),"%B %d,%Y")) %>%
    
  # Slide 2 - Caseload historical comparison:
  add_slide(layout = "Content Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Caseload Historical Comparison") %>% 
  ph_with_table(type = "body", index = 2, value = slide2.data) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "2" ) %>%
  
  # Slide 3 - Caseload by Consultant:
  add_slide(layout = "Content Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Caseload by Consultant") %>% 
  ph_with_table(type = "body", index = 2, value = slide3.data) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "3" ) %>%
  ph_with_text(type = "dt", str = format(Sys.Date(),"%B %d,%Y")) %>%
  
  # Slide 4 - Mortalities <= 30 days:
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Mortalities <= 30 days") %>% 
  ph_with_table(type = "body", index=3, value = slide4.data1) %>%
  ph_with_table(type = "body", index=2, value = slide4.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "4" ) %>%
  ph_with_text(type = "dt", str = format(Sys.Date(),"%B %d,%Y")) %>%
    
  # Slide 5 - Outpatient Wait Days:
  add_slide(layout = "Table Graph and Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index = 1, str = "Outpatient Wait Days") %>% 
  ph_with_gg(type = "body", index = 2, value = slide5.plot) %>%
  ph_with_table(type = "body", index = 1, value = slide5.data) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "5" ) %>%
  ph_with_text(type = "dt", str = format(Sys.Date(),"%B %d,%Y")) %>%
    
  # Slide 6 - Outpatient Wait > 90:
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index = 1, str = "Outpatient Wait > 90 Day") %>%
  ph_with_table(type = "body", index=3, value = slide6.data1) %>%
  ph_with_table(type = "body", index=2, value = slide6.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "6" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%
    
  # Slide 7 - Inpatient Wait Days:
  add_slide(layout = "Table Graph and Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index = 1, str = "Inpatient Wait Days") %>% 
  ph_with_gg(type = "body", index = 2, value = slide7.plot) %>%
  ph_with_table(type = "body", index = 1, value = slide7.data) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "7" ) %>%
  ph_with_text(type = "dt", str = format(Sys.Date(),"%B %d,%Y")) %>%    
  
  # Slide 8 - Inpatient Wait > 10 days:
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Inpatient Wait > 10 days") %>% 
  ph_with_table(type = "body", index=3, value = slide8.data1) %>%
  ph_with_table(type = "body", index=2, value = slide8.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "8" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%
  
  # Slide 9 - ICU Stay (days):
  add_slide(layout = "Table Graph and Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "ICU Stay") %>% 
  ph_with_gg(type = "body", index = 2, value = slide9.plot) %>%
  ph_with_table(type = "body", index = 1, value = slide9.data) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "9" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%
  
  # Slide 10 - Prolonged ICU Stay (>3 days):
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Prolonged ICU Stay (>3 days)") %>% 
  ph_with_table(type = "body", index=3, value = slide10.data1) %>%
  ph_with_table(type = "body", index=2, value = slide10.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "10" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%
  
  # Slide 11 - Post-OP LOS (days):
  add_slide(layout = "Table Graph and Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Post-OP LOS") %>% 
  ph_with_gg(type = "body", index = 2, value = slide11.plot) %>%
  ph_with_table(type = "body", index = 1, value = slide11.data) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "11" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%
  
  # Slide 12 - Prolonged Post-OP LOS (>10 days):
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Prolonged Post-OP LOS (>10 days)") %>% 
  ph_with_table(type = "body", index=3, value = slide12.data1) %>%
  ph_with_table(type = "body", index=2, value = slide12.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "12" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%  

  # Slide 13 - Post-op AMI or Cardiac Arrest:
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Post-op AMI or Cardiac Arrest") %>% 
  ph_with_table(type = "body", index=3, value = slide13.data1) %>%
  ph_with_table(type = "body", index=2, value = slide13.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "13" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>%

  # slide 14 - IABP Use
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "IABP Use") %>% 
  ph_with_table(type = "body", index=3, value = slide14.data1) %>%
  ph_with_table(type = "body", index=2, value = slide14.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "14" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 

  # slide 15 - Transfusions
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Transfusions") %>% 
  ph_with_table(type = "body", index=3, value = slide15.data1) %>%
  ph_with_table(type = "body", index=2, value = slide15.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "15" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 

  # slide 16 - Reintubation & Return to ICU
  add_slide(layout = "Triple Table and Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Reintubation & Return to ICU") %>% 
  ph_with_table(type = "body", index=1, value = slide16.data1) %>%
  ph_with_table(type = "body", index=2, value = slide16.data2) %>%
  ph_with_table(type = "body", index=3, value = slide16.data3) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "16" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 

  # slide 17 - Return to Theatre
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Return to Theatre") %>% 
  ph_with_table(type = "body", index=3, value = slide17.data1) %>%
  ph_with_table(type = "body", index=2, value = slide17.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "17" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 

  # slide 18 - Infections
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Infections") %>% 
  ph_with_table(type = "body", index=3, value = slide18.data1) %>%
  ph_with_table(type = "body", index=2, value = slide18.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "18" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 

  # slide 19 - Infection details
  add_slide(layout = "Content Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1, str = "Infection details") %>% 
  ph_with_table(type = "body", index=2, value = slide19.data1) %>%
  ph_with_text(type = "ftr", str = myftr) %>%
  ph_with_text(type = "sldNum", str = "19") %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 
    
  # slide 20 - Atrial Fibrillation & Arrhythmias
  add_slide(layout = "Content Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1, str = "Atrial Fibrillation & Arrhythmias") %>% 
  ph_with_table(type = "body", index=2, value = slide20.data1) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "20" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 
  
  # slide 21 - Neurological Events
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Neurological Events") %>% 
  ph_with_table(type = "body", index=3, value = slide21.data1) %>%
  ph_with_table(type = "body", index=2, value = slide21.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "21" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 
  
  # slide 22 - Other Post-Op Complications
  add_slide(layout = "Content Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1, str = "Other Post-Op Complications") %>% 
  ph_with_table(type = "body", index=2, value = slide22.data1) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "22" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y")) %>% 
  
  # slide 23 - Readmitted <= 30 days 
  add_slide(layout = "Double Table Small Title", master = "Office Theme") %>%
  ph_with_text(type = "title", index=1,str = "Readmitted <= 30 days") %>% 
  ph_with_table(type = "body", index=3, value = slide23.data1) %>%
  ph_with_table(type = "body", index=2, value = slide23.data2) %>%
  ph_with_text(type = "ftr", str = myftr ) %>%
  ph_with_text(type = "sldNum", str = "23" ) %>%
  ph_with_text(type = "dt", str =format(Sys.Date(),"%B %d,%Y"))
  
  # Print to save powerpoint

  if(No.Months == 1){
    MM.filename <- paste(First.Month,"_", Year, "_M&M.pptx", sep = "")
  } else if(No.Months >= 2){
    MM.filename <- paste(First.Month,Second.Month,"_", Year, "_M&M.pptx", sep = "")
  }

  print(doc, target = MM.filename) %>% 
  invisible()

```

